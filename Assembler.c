#include<stdio.h>#include<stdlib.h>#include<string.h>void intermediate(void);int duplicate(char *label);void header(void);char *getopVal(char *opcode);char *getlabVal(char *label);void textrecord(void);int PROLEN;int main(int argc, char const *argv[]){    intermediate();    header();    textrecord();    return 0;}void intermediate(){    FILE *fpr;    FILE *fpw;    FILE *fsym;    char str[200],*ret,*label,*opcode,*operand,str1[200];    int locctr=0x00,startingAddress=0x00,count=1,flag=0;    fpw = fopen("intermediate.txt", "w");    fpr = fopen("input.txt", "r");    fsym = fopen("symbol.txt","w");    int j=0,k=0,line=0;    char ch;    ch = fgetc(fpr);    while(!feof(fpr))    {        if(ch != '\n')        {            str[j]=ch;            //printf("%c",ch);            j++;        }        else        {            line++;            str[j]='\0';            ret = strtok(str," \t\n");            label = ret;            while(ret != NULL)            {                ret = strtok(NULL," \t\n");                count++;                if(count==2)                    opcode = ret;                else if(count == 3)                    operand = ret;            }            if(line==1 && strcmp(opcode,"START")==0)            {                printf("START FOUND\n");                locctr=(int)strtol(operand,NULL,16);                startingAddress=locctr;                //printf("%d %d\n",locctr,startingAddress);                fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                if(duplicate(label))                fprintf(fsym,"%X %s\n",locctr,label);                printf("%X %s %s %s\n",locctr,label,opcode,operand);                continue;            }            else if(line==1 && strcmp(opcode,"START")!=0)            {                //printf("START NOT FOUND\n");                //printf("%d %d\n",locctr,startingAddress);            }            else if(strcmp(label,"END")==0)            {                printf("\n\nEND FOUND .... Exiting\n");                printf("\nstarting address is %X and final address is %X \n",startingAddress,locctr);                printf("\nProgram length is %X\n",locctr-startingAddress);                PROLEN = locctr-startingAddress;                break;            }            if(count == 4)            {                FILE *fop;                fop = fopen("optab.txt","r");                char cc,*ret1;                cc = fgetc(fop);                flag = 0;                while(!feof(fop))                {                    if(cc != '\n')                    {                        str1[k]=cc;                        k++;                    }                    else                    {                        str1[k]='\0';                        k=0;                        ret1 = strtok(str1," \t\n");                        while(ret1 != NULL)                        {                        if(strcmp(opcode,ret1)==0)      // OPCODE MATCHES WITH SYMBOL TABLE                        {                            //printf("%s found in optab\n",opcode);                            flag=1;                            fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                            if(duplicate(label))                            fprintf(fsym,"%X %s\n",locctr,label);                            printf("%X %s %s %s\n",locctr,label,opcode,operand);                            locctr+=3;                        }                        ret1 = strtok(NULL," \t\n");                        }                    }                    cc = fgetc(fop);                }                fclose(fop);                if(flag == 0)                {                    //printf("%s not found in optab\n",opcode);                    if(strcmp(opcode,"WORD")==0)                    {                        fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                        if(duplicate(label))                        fprintf(fsym,"%X %s\n",locctr,label);                        printf("%X %s %s %s\n",locctr,label,opcode,operand);                        locctr+=3;                    }                    else if(strcmp(opcode,"RESW")==0)                    {                        fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                        if(duplicate(label))                        fprintf(fsym,"%X %s\n",locctr,label);                        printf("%X %s %s %s\n",locctr,label,opcode,operand);                        locctr=locctr + (3*(int)strtol(operand,NULL,16));                    }                    else if(strcmp(opcode,"RESB")==0)                    {                        fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                        if(duplicate(label))                        fprintf(fsym,"%X %s\n",locctr,label);                        printf("%X %s %s %s\n",locctr,label,opcode,operand);                        locctr=locctr + 0x00 + ((int)strtol(operand,NULL,10));                    }                    else if(strcmp(opcode,"BYTE")==0)                    {                        fprintf(fpw,"%X %s %s %s\n",locctr,label,opcode,operand);                        if(duplicate(label))                        fprintf(fsym,"%X %s\n",locctr,label);                        printf("%X %s %s %s\n",locctr,label,opcode,operand);                        int len;                        len = strlen(operand)-3;                        if(operand[0]=='C')                            locctr=locctr+len;                        else                            locctr=locctr+(len/2);                    }                    else                    {                        fprintf(fpw,"     %s %s %s\n",label,opcode,operand);                        printf("     %s %s %s\n",label,opcode,operand);                    }                }            } // end of token = 4            else if(count == 3) // ONLY opcode and operand            {                operand = opcode;                opcode = label;                FILE *fop;                fop = fopen("optab.txt","r");                char cc,*ret1;                cc = fgetc(fop);                flag = 0;                while(!feof(fop))                {                    if(cc != '\n')                    {                        str1[k]=cc;                        k++;                    }                    else                    {                        str1[k]='\0';                        k=0;                        ret1 = strtok(str1," \t\n");                        while(ret1 != NULL)                        {                        if(strcmp(opcode,ret1)==0)      // OPCODE MATCHES WITH SYMBOL TABLE                        {                            //printf("%s found in optab\n",opcode);                            flag=1;                            fprintf(fpw,"%X %s %s\n",locctr,opcode,operand);                            printf("%X %s %s\n",locctr,opcode,operand);                            locctr+=3;                        }                        ret1 = strtok(NULL," \t\n");                        }                    }                    cc = fgetc(fop);                }                fclose(fop);                if(flag == 0)                {                    //printf("%s not found in optab\n",opcode);                    if(strcmp(opcode,"WORD")==0)                    {                        fprintf(fpw,"%X %s %s\n",locctr,opcode,operand);                        printf("%X %s %s\n",locctr,opcode,operand);                        locctr+=3;                    }                    else if(strcmp(opcode,"RESW")==0)                    {                        fprintf(fpw,"%X %s %s\n",locctr,opcode,operand);                        printf("%X %s %s\n",locctr,opcode,operand);                        locctr=locctr + (3*(int)strtol(operand,NULL,16));                    }                    else if(strcmp(opcode,"RESB")==0)                    {                        fprintf(fpw,"%X %s %s\n",locctr,opcode,operand);                        printf("%X %s %s\n",locctr,opcode,operand);                        locctr=locctr+0x00 +((int)strtol(operand,NULL,10));                    }                    else if(strcmp(opcode,"BYTE")==0)                    {                        fprintf(fpw,"%X %s %s\n",locctr,opcode,operand);                        printf("%X %s %s\n",locctr,opcode,operand);                        int len;                        len = strlen(operand)-3;                        if(operand[0]=='C')                            locctr=locctr+len;                        else                            locctr=locctr+(len/2);                    }                }            }            else if(count == 2) //ONLY opcode            {                opcode = label;                FILE *fop;                fop = fopen("optab.txt","r");                char cc,*ret1;                cc = fgetc(fop);                flag = 0;                while(!feof(fop))                {                    if(cc != '\n')                    {                        str1[k]=cc;                        k++;                    }                    else                    {                        str1[k]='\0';                        k=0;                        ret1 = strtok(str1," \t\n");                        while(ret1 != NULL)                        {                        if(strcmp(opcode,ret1)==0)      // OPCODE MATCHES WITH SYMBOL TABLE                        {                            //printf("%s found in optab\n",opcode);                            flag=1;                            fprintf(fpw,"%X %s\n",locctr,opcode);                            printf("%X %s\n",locctr,opcode);                            locctr+=3;                        }                        ret1 = strtok(NULL," \t\n");                        }                    }                    cc = fgetc(fop);                }                fclose(fop);                if(flag == 0)                {                    printf("%s not found in optab\n",opcode);                }            } // END of TOKEN 1            count = 1;            j=0;        }        ch = fgetc(fpr);    }    fclose(fpr);    fclose(fpw);    fclose(fsym);}int duplicate(char *label){    FILE *fp;    fp=fopen("symbol.txt","r");    char ch,*ret,str[100];    int j=0;    ch = fgetc(fp);    while(!feof(fp))    {        if(ch != '\n')        {            str[j]=ch;            //printf("%c",ch);            j++;        }        else        {            str[j]='\0';            ret = strtok(str," \t\n");            while(ret != NULL)            {                ret = strtok(NULL," \t\n");                if(strcmp(label,ret)==0)                {                    printf("label found\n");                    return 0;                }            }        }        j=0;    }    printf("label not found\n");    fclose(fp);    return 1;}void header(void){    FILE *fpr,*fpw,*obcode;    char ch,*ret,*opcode,*operand,*label,*addr,str[100];    int line=0,j=0,count=1;    fpr = fopen("intermediate.txt","r");    fpw = fopen("header.txt","w");    obcode = fopen("obcodes.txt","w");    ch = fgetc(fpr);    while(!feof(fpr))    {        if(ch != '\n')        {            str[j]=ch;            //printf("%c",ch);            j++;        }        else        {            line++;            str[j]='\0';            j=0;            printf("\n\n%s\n",str);            ret = strtok(str," \t\n");            addr = ret;            while(ret != NULL)            {                ret = strtok(NULL," \t\n");                count++;                if(count==2)                    label = ret;                else if(count == 3)                    opcode = ret;                else if(count == 4)                    operand = ret;            }            //printf("%s %s %s\n",addr,label,opcode);            if(line==1 && strcmp(opcode,"START")==0)            {                printf("Start Found\n");                fprintf(fpw,"H^%s^%s^%X\n",label,operand,PROLEN);            }            else            {                char *opcodeVal,*labelVal,t1[10],t2[10];                if(count==5)                {                    if(strcmp(opcode,"RESB")==0)                    {                    }                    else if(strcmp(opcode,"RESW")==0)                    {                    }                    else if(strcmp(opcode,"WORD")==0)                    {                        char temp[10];                        strcpy(temp,operand);                        int decimal,tempDecimal,count=0,diff;                        decimal = strtol(temp,NULL,10);                        tempDecimal = decimal;                        while(tempDecimal>0)                        {                            tempDecimal/=10;                            count++;                        }                        diff = 6-count;                        printf("Object Code is ");                        while(diff>0)                        {                            printf("%c",'0');                            fprintf(obcode,"%c",'0');                            diff--;                        }                        printf("%X\n\n",decimal);                        fprintf(obcode,"%X\n",decimal);                    }                     else if(strcmp(opcode,"BYTE")==0)                    {                        char constant[20];                        int temp=0x00;                        strcpy(constant,operand);                        int i=2;                        printf("Object Code ");                        if(constant[0]=='C')                        {                        while(constant[i]!='\0')                        {                            if(constant[i]!='\'')                            {                                printf("%X",constant[i]);                                fprintf(obcode,"%X",constant[i]);                            }                            i++;                        }                        fprintf(obcode,"\n");                        }                        else                        {                            while(constant[i]!='\0')                            {                                if(constant[i]!='\'')                                {                                    printf("%c",constant[i]);                                    fprintf(obcode,"%c",constant[i]);                                }                                i++;                            }                            fprintf(obcode,"\n");                        }                        printf("\n");                    }                    else                    {                    opcodeVal = getopVal(opcode);                    strcpy(t1,opcodeVal);                    if(strcmp(opcodeVal,"nan")!=0)                    {                        printf("Value of %s is %s\n",opcode,opcodeVal,label);                    }                    labelVal = getlabVal(operand);                    strcpy(t2,labelVal);                    if(strcmp(t2,"nan")!=0)                    {                    printf("Value of %s is %s\n\n",operand,labelVal);                    printf("Object Code %s%s\n",t1,t2);                    fprintf(obcode,"%s%s\n",t1,t2);                    }                    else                    {                        printf("Object Code %s0000\n\n",t1);                        fprintf(obcode,"%s0000\n",t1);                        printf("-----ERROR %s not found in SYMTAB-----\n\n",operand);                    }                    }                }                else if(count == 4)                {                    if(strcmp(label,"EQU")==0)                    {                        printf("<<not defined>>\n");                    }                    else                    {                    opcodeVal = getopVal(label);                    strcpy(t1,opcodeVal);                    if(strcmp(opcodeVal,"nan")!=0)                        printf("Value of %s is %s\n",label,opcodeVal);                    labelVal = getlabVal(opcode);                    strcpy(t2,labelVal);                    if(strcmp(t2,"nan")!=0)                    {                        printf("Value of %s is %s\n\n",opcode,labelVal);                        printf("Object Code %s%s\n",t1,t2);                        fprintf(obcode,"%s%s\n",t1,t2);                    }                    else                    {                        printf("Object Code %s0000\n",t1);                        fprintf(obcode,"%s0000\n",t1);                        printf("------ERROR %s not found in SYMTAB------\n",opcode);                    }                    }                }                else if(count == 3)                {                    opcodeVal = getopVal(label);                    strcpy(t1,opcodeVal);                    if(strcmp(opcodeVal,"nan")!=0)                        printf("Value of %s is %s\n",label,opcodeVal);                    printf("Object Code %s0000\n",t1);                    fprintf(obcode,"%s0000\n",t1);                }            }        }        ch = fgetc(fpr);        count=1;    }    fclose(obcode);}char *getopVal(char *opcode){    FILE *fpr;    fpr = fopen("optab.txt","r");    char ch,str[100],*ret,*addr,*oc;    int j=0,flag=0,count=1;    ch = fgetc(fpr);    while(!feof(fpr))    {        if(ch != '\n')        {            str[j]=ch;            j++;        }        else        {            str[j]='\0';            j=0;            ret = strtok(str," \t\n");            oc = ret;            while(ret != NULL)            {                count++;                ret = strtok(NULL," \t\n");                if(count == 2)                    addr = ret;            }            if(count == 3)            {                if(strcmp(oc,opcode)==0)                {                    flag = 1;                    return addr;                }            }        }    count = 1;    ch = fgetc(fpr);    }    fclose(fpr);    if(flag == 0)        //printf("%s not found\n",opcode);    return "nan";}char *getlabVal(char *label){    FILE *fpr;    fpr = fopen("symbol.txt","r");    char ch,str[100],*ret,*addr,*oc;    int j=0,flag=0,count=1;    ch = fgetc(fpr);    while(!feof(fpr))    {        if(ch != '\n')        {            str[j]=ch;            j++;        }        else        {            str[j]='\0';            j=0;            ret = strtok(str," \t\n");            addr = ret;            while(ret != NULL)            {                count++;                ret = strtok(NULL," \t\n");                if(count == 2)                    oc = ret;            }            if(count == 3)            {                if(strcmp(oc,label)==0)                {                    flag = 1;                    return addr;                }            }        }    count = 1;    ch = fgetc(fpr);    }    fclose(fpr);    if(flag == 0)        //printf("%s not found\n",label);    return "nan";}void textrecord(){    printf("---------TEXT RECORD------------\n");    FILE *fpr,*fpw;    char arr[20],*arr1;    fpr = fopen("obcodes.txt","r");    fpw = fopen("header.txt","a");    char ch;    int count = 0,maincount=0;    int i = 0;    ch = fgetc(fpr);    fprintf(fpw,"T");    while(!feof(fpr))    {        if(ch!='\n')        {            arr[i]=ch;            i++;            count++;        }        else        {            arr[i]='\0';            i=0;            printf("%d\n",count);            if((maincount+count)<=60)            {                maincount+=count;                fprintf(fpw,"^%s",arr);            }            else            {                maincount=0;                fprintf(fpw,"\nT");            }            count=0;        }        ch = fgetc(fpr);    }}